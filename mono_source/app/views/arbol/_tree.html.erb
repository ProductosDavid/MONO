<!--
    MONO
    Copyright (C) 2015  Universidad de los Andes
  
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.
  
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
  
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<link rel="stylesheet" type="text/css" href="/assets/themes/default/style.css">

<div id="sgw_4_body" class="body sg_scroll_container sgw_entity_query_entity_query_page" style="top:0px;" >

  <div class="contents" id="ext-gen77" style="left: 0px; top: 0px;  " >
    <%
       @filtroTexto = t('.filtro')
       @verListaTexto = t('viewList')
       @verIconosTexto = t('viewSharp')

       @nuevoBotonId = "nuevo_plantilla"
       @nuevoBotonTexto = t('add')
       @nuevoPath = actividads_path
       @nuevoModal = "nuevaactividad"

       @editarBotonId = "editar_actividad"
       @editarBotonTexto = t('edit')
       @editarPath = "#"
       @editarModal = "editaractividad"

       @eliminarBotonId = "eliminar_actividad"
       @eliminarBotonTexto = t('delete')
       @eliminarPath = "#"
       @eliminarModal = "eliminaractividad"
       @eliminarConfirm = "EstÃ¡ seguro de querer eliminar la actividad?"


       @filtro = t('.filtro')
       @limpiar= t('.limpiar')
       @nuevo= t('.nuevo')
       @actividadtexto = t('.actividad')
       @actSimple= t('.actSimple')
       @actMultiSeq= t('.actMultiSeq')
       @actMultiPara= t('.actMultiPara')
       @compuertatexto = t('.compuerta')
       @compuerta_inclu= t('.compuerta_inclu')
       @compuerta_exclu= t('.compuerta_exclu')
       @compuerta_para= t('.compuerta_para')
       @evento_inicio= t('.evento_inicio')
       @evento_fin= t('.evento_fin')
       @rename= t('.rename')
       @remove= t('.remove')
       @cut= t('.cut')
       @copy= t('.copy')
       @paste= t('.paste')
       @editar= t('.editar')
    %>
    <div id="layout_principal1" class="sgw_new_grid sgw_entity_query_mode sg_scroll_container seltarget" style="left: 0px; top: 0px; ">
      <div id="demo" class="demo"  style=" width: 200%; height: 200% ">
      </div>

      <script type="text/javascript" class="source below">
          $(function () {
              $("#demo")
                      .bind("loaded.jstree", function (event, data) {
                          // you get two params - event & data - check the core docs for a detailed description
                          $(this).jstree("open_all");
                      })
                      .bind("before.jstree", function (e, data) {
                          $("#alog").append(data.func + "<br />");
                      })
                      .jstree({
                          // List of active plugins
                          <%if !@plantilla.nil? || @proceso.estado != "publicado" %>
                          "plugins" : [
                              "themes","json_data","ui","crrm","cookies","dnd","search","types","hotkeys","contextmenu"
                          ],
                          <% else %>
                          "plugins" : [
                              "themes","json_data","ui","crrm","cookies","dnd","search","types","hotkeys"
                          ],
                          <% end %>
                          "json_data" : {
                              "ajax" : {
                                  "url" : "/treedata.json",
                                  "data" : function (n) {
                                      return {
                                          "operation" : "get_children",
                                          "id" : n.attr ? n.attr("id").replace("node_","") : 1,
                                          "real_id": n.attr ?  n.attr("realid") : 0,
                                          <%if @proceso.nil?%>
                                            "plantilla_id": n.attr ?  n.attr("plantilla_id") : <%= @plantilla.id %>,
                                          <%else%>
                                            "proceso_id": n.attr ?  n.attr("proceso_id") : <%= @proceso.id %>,
                                          <%end%>
                                      };
                                  }
                              }
                          },
                          // Configuring the search plugin
                          "search" : {
                              "ajax" : {
                                  "url" :  "/treedata.json",
                                  "data" : function (str) {
                                      return {
                                          "operation" : "search",
                                          "search_str" : str
                                      };
                                  }
                              }
                          },
                          "types" : {
                              "valid_children":["root"],
                              "types" : {
                                  "root" : {
                                      "valid_children":["evento_inicio"],
                                      "icon" : {
                                          "image" : "/images/base.gif"
                                      }
                                  },
                                  // The default type
                                  "tarea_simple" : {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/Tarea_simple_icono.png"
                                      }
                                  },
                                  "tarea_multi_seq" : {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/Tarea_multi_seq_icono1.png"
                                      }
                                  },
                                  "tarea_multi_para" : {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/Tarea_multi_para_icono1.png"
                                      }
                                  },
                                  // The `folder` type
                                  "compuerta_inclu" : {
                                      "valid_children":["ruta","andjoin_inclu"],
                                      "icon" : {
                                          "image" : "/images/compuerta_inclu_icono.png"
                                      }
                                  },
                                  "compuerta_exclu" : {
                                      "valid_children":["ruta","andjoin_exclu"],
                                      "icon" : {
                                          "image" : "/images/compuerta_icono.png"
                                      }
                                  },
                                  // The `drive` nodes
                                  "compuerta_para" : {
                                      "valid_children":["ruta", "andjoin_para"],
                                      "icon" : {
                                          "image" : "/images/compuerta_para_icono.png"
                                      }
                                  },
                                  "evento_inicio" : {
                                      "valid_children":["evento_fin","evento_intermedio","compuerta_para","compuerta_exclu","compuerta_inclu","tarea_multi_para","tarea_multi_seq","tarea_simple","loop"],
                                      "icon" : {
                                          "image" : "/images/evento_inicio_icono.png"
                                      }
                                  },
                                  "evento_fin" : {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/evento_fin_icono.png"
                                      }
                                  },
                                  "evento_intermedio" : {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/evento_intermedio_icono.png"
                                      }
                                  },
                                  "ruta" : {
                                      "valid_children":["evento_fin","evento_intermedio","compuerta_para","compuerta_exclu","compuerta_inclu","tarea_multi_para","tarea_multi_seq","tarea_simple","loop","merge"],
                                      "icon" : {
                                          "image" : "/images/bifurcacion_icono.png"
                                      }
                                  },
                                  "loop" :
                                  {

                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/loop_icono.png"
                                      }
                                  },
                                  "merge" :
                                  {
                                      "valid_children":[""],
                                      "icon" : {
                                          "image" : "/images/merge_icono.png"
                                      }
                                  }
                              }
                          },
                          <%if !@plantilla.nil? || @proceso.estado != "publicado" %>
                          "contextmenu" : {
                              "items" : function customMenu(node) {

                                  var items = {
                                      create : {
                                          "separator_before"	: true,
                                          "icon"                  :"/images/mail.png",
                                          "separator_after"	: false,
                                          "label"				: '<%= t('.nuevo')%> ',
                                          "action"			: false,
                                          "submenu" : {
                                              actividad : {
                                                  "separator_before"	: false, "separator_after"	: false,
                                                  "label"				: '<%= t('.new_actividad')%> ',
                                                  "action"			: false,
                                                  "submenu" : {
                                                      "simple" : {
                                                          "separator_before"	: false,
                                                          "separator_after"	: false,
                                                          "icon"                :"/images/Tarea_simple_icono.png",
                                                          "label"		: '<%= t('.actSimple')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "tarea_simple","parent_id" : node.attr("id"),"id":"NuevoNodo", "parent_type" : node.attr("rel") }}); }
                                                      },
                                                      "multi_seq" : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/Tarea_multi_seq_icono1.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.actMultiSeq')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "tarea_multi_seq","parent_id" : node.attr("id"),"id":"NuevoNodo", "parent_type" : node.attr("rel") }}); }
                                                      },
                                                      "multi_para" : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/Tarea_multi_para_icono1.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.actMultiPara')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "tarea_multi_para","parent_id" : node.attr("id"),"id":"NuevoNodo", "parent_type" : node.attr("rel") }}); }
                                                      }
                                                  }
                                              },
                                              compuerta : {
                                                  "separator_before"	: false,
                                                  "icon"			: false,
                                                  "separator_after"	: false,
                                                  "label"			: '<%= t('.compuerta')%> ',
                                                  "action"		: false,
                                                  "submenu" : {
                                                      "Inclu" : {
                                                          "separator_before"	: false,
                                                          "icon"                :"/images/compuerta_inclu_icono.png",
                                                          "separator_after"	: false,
                                                          "label"		:'<%= t('.compuerta_inclu')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "compuerta_inclu","id":"NuevoNodo"}}); }
                                                      },
                                                      "Exclu" : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/compuerta_icono.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.compuerta_exclu')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "compuerta_exclu","id":"NuevoNodo"}}); }
                                                      },
                                                      "Para" : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/compuerta_para_icono.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.compuerta_para')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "compuerta_para","id":"NuevoNodo"}}); }
                                                      }
                                                  }
                                              },
                                              evento : {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "label"				: '<%= t('.evento')%> ',
                                                  "action"			: false,
                                                  "submenu" : {
                                                      fin : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/evento_fin_icono.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.evento_fin')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "evento_fin","parent_id" : node.attr("id"), "parent_type" : node.attr("rel"),"id":"NuevoNodo" }}); }
                                                      },
                                                      intermedio : {
                                                          "separator_before"	: false,
                                                          "icon"		: "/images/evento_intermedio_icono.png",
                                                          "separator_after"	: false,
                                                          "label"		: '<%= t('.evento_intermedio')%> ',
                                                          "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "evento_intermedio","parent_id" : node.attr("id"), "parent_type" : node.attr("rel"),"id":"NuevoNodo" }}); }
                                                      }
                                                  }
                                              },
                                              ruta : {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "icon"                  :"/images/bifurcacion_icono.png",
                                                  "label"				: '<%= t('.ruta')%> ',
                                                  "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "ruta","parent_id" : node.attr("id"), "parent_type" : node.attr("rel"),"id":"NuevoNodo" }}); }
                                              },
                                              loop: {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "icon"                  :"/images/loop_icono.png",
                                                  "label"				: '<%= t('.loop')%> ',
                                                  "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "loop","parent_id" : node.attr("id"), "parent_type" : node.attr("rel"),"id":"NuevoNodo" }}); }

                                              },
                                              merge: {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "icon"                  :"/images/merge_icono.png",
                                                  "label"				: '<%= t('.merge')%> ',
                                                  "action"		: function (obj) { this.create(obj, "last", {"attr" : {"rel" : "merge","parent_id" : node.attr("id"), "parent_type" : node.attr("rel"),"id":"NuevoNodo" }}); }

                                              }
                                          }
                                      },
                                      rename : {
                                          "separator_before"	: false,
                                          "separator_after"	: false,
                                          "icon"                  :"/images/files_edit.png",
                                          "label"				: '<%= t('.rename')%> ',
                                          "action"			: function (obj) { this.rename(obj); }
                                      },
                                      remove : {
                                          "separator_before"	: false,
                                          "icon"			: "/images/trash.png",
                                          "separator_after"	: false,
                                          "label"			: '<%= t('.remove')%> ',
                                          "action"		: function (obj) { if(this.is_selected(obj)) { this.remove(); } else { this.remove(obj); } }
                                      },
                                      ccp : {
                                          "separator_before"	: true,
                                          "icon"				: false,
                                          "separator_after"	: false,
                                          "label"				: '<%= t('.editar')%> ',
                                          "action"			: false,
                                          "submenu" : {
                                              cut : {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "icon"                  :"/images/tijeras.png",
                                                  "label"				: '<%= t('.cut')%> ',
                                                  "action"			: function (obj) { this.cut(obj); }
                                              },
                                              copy : {
                                                  "separator_before"	: false,
                                                  "icon"			: "/images/copiar1.png",
                                                  "separator_after"	: false,
                                                  "label"				: '<%= t('.copy')%> ',
                                                  "action"			: function (obj) { this.copy(obj); }
                                              },
                                              paste : {
                                                  "separator_before"	: false,
                                                  "icon"			: "/images/pegar1.png",
                                                  "separator_after"	: false,
                                                  "label"				: '<%= t('.paste')%> ',
                                                  "action"			: function (obj) { this.paste(obj); }
                                              }
                                          }
                                      },
                                      cambiar_compuerta : {
                                          "separator_before"	: true,
                                          "icon"				: false,
                                          "separator_after"	: false,
                                          "label"				: '<%= t('.cambiar_compuerta')%> ',
                                          "action"			: false,
                                          "submenu" : {
                                              "Inclu" : {
                                                  "separator_before"	: false,
                                                  "icon"                :"/images/compuerta_inclu_icono.png",
                                                  "separator_after"	: false,
                                                  "label"		:'<%= t('.compuerta_inclu')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'compuerta_inclu',1); }
                                              },
                                              "Exclu" : {
                                                  "separator_before"	: false,
                                                  "icon"		: "/images/compuerta_icono.png",
                                                  "separator_after"	: false,
                                                  "label"		: '<%= t('.compuerta_exclu')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'compuerta_exclu',2); }
                                              },
                                              "Para" : {
                                                  "separator_before"	: false,
                                                  "icon"		: "/images/compuerta_para_icono.png",
                                                  "separator_after"	: false,
                                                  "label"		: '<%= t('.compuerta_para')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'compuerta_para',3); }
                                              }

                                          }
                                      },
                                      cambiar_tarea : {
                                          "separator_before"	: true,
                                          "icon"				: false,
                                          "separator_after"	: false,
                                          "label"				: '<%= t('.cambiar_tarea')%> ',
                                          "action"			: false,
                                          "submenu" : {
                                              "simple" : {
                                                  "separator_before"	: false,
                                                  "separator_after"	: false,
                                                  "icon"                :"/images/Tarea_simple_icono.png",
                                                  "label"		: '<%= t('.actSimple')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'tarea_simple',1); }
                                              },
                                              "multi_seq" : {
                                                  "separator_before"	: false,
                                                  "icon"		: "/images/Tarea_multi_seq_icono1.png",
                                                  "separator_after"	: false,
                                                  "label"		: '<%= t('.actMultiSeq')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'tarea_multi_seq',2); }
                                              },
                                              "multi_para" : {
                                                  "separator_before"	: false,
                                                  "icon"		: "/images/Tarea_multi_para_icono1.png",
                                                  "separator_after"	: false,
                                                  "label"		: '<%= t('.actMultiPara')%> ',
                                                  "action"		: function (obj) { $.cambiar_elemento(obj,'tarea_multi_para',3); }
                                              }

                                          }
                                      }

                                  };

                                  if ($(node).attr("rel") == "root") {
                                      // Delete the "delete" menu item
                                      // delete items.delete_item;
                                      // Disabling instead
                                      // items.shortcut._disabled = true;
                                      delete items.create
                                      delete items.ccp
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;


                                  }
                                  else if ($(node).attr("rel") == "compuerta_para") {
                                      delete items.create.submenu.actividad;
                                      delete items.create.submenu.compuerta;
                                      delete items.create.submenu.evento;
                                      delete items.create.submenu.loop;
                                      delete items.create.submenu.merge;
                                      delete items.cambiar_compuerta.submenu.Para;
                                      delete items.cambiar_tarea;


                                  }
                                  else if ($(node).attr("rel") == "compuerta_inclu") {
                                      delete items.create.submenu.actividad;
                                      delete items.create.submenu.compuerta;
                                      delete items.create.submenu.evento;
                                      delete items.create.submenu.loop;
                                      delete items.create.submenu.merge;
                                      delete items.cambiar_compuerta.submenu.Inclu;
                                      delete items.cambiar_tarea;


                                  }
                                  else if ($(node).attr("rel") == "compuerta_exclu") {
                                      delete items.create.submenu.actividad;
                                      delete items.create.submenu.compuerta;
                                      delete items.create.submenu.evento;
                                      delete items.create.submenu.loop;
                                      delete items.create.submenu.merge;
                                      delete items.cambiar_compuerta.submenu.Exclu;
                                      delete items.cambiar_tarea;

                                  }
                                  else if ($(node).attr("rel") == "ruta") {
                                      delete items.create.submenu.ruta;
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;
                                      delete items.create.submenu.merge;



                                  }
                                  else if ($(node).attr("rel") == "evento_fin") {
                                      delete items.create
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;


                                  }
                                  else if ($(node).attr("rel") == "tarea_simple") {
                                      delete items.create
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea.submenu.simple;


                                  }
                                  else if ($(node).attr("rel") == "tarea_multi_seq") {
                                      delete items.create
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea.submenu.multi_seq;


                                  }
                                  else if ($(node).attr("rel") == "tarea_multi_para") {
                                      delete items.create
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea.submenu.multi_para;
                                  }
                                  else if ($(node).attr("rel") == "evento_inicio"||$(node).attr("rel") == "evento_intermedio") {
                                      delete items.create.submenu.ruta;
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;
                                      delete items.create.submenu.loop;
                                      delete items.create.submenu.merge;


                                  }
                                  else if ($(node).attr("rel") == "loop") {
                                      delete items.create;
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;

                                  }
                                  else if ($(node).attr("rel") == "merge") {
                                      delete items.create;
                                      delete items.cambiar_compuerta;
                                      delete items.cambiar_tarea;

                                  }
                                  return items;
                              }
                          }
                          <%end%>

                      })
                      .bind("select_node.jstree", function (event, data) {
                          var selectedObj = data.rslt.obj;
                          if(selectedObj.attr("rel") == "tarea_simple" ||
                                  selectedObj.attr("rel") == "tarea_multi_para" ||
                                  selectedObj.attr("rel") == "tarea_multi_seq")
                          {
                              $("#frame_actividad").attr("src","<%= request.protocol + request.host_with_port %>/actividads/" + selectedObj.attr("idreal") +  "/edit?locale=<%= params[:locale]%>");
                          }
                          else if(selectedObj.attr("rel") == "compuerta_para" ||
                                  selectedObj.attr("rel") == "compuerta_exclu" ||
                                  selectedObj.attr("rel") == "compuerta_inclu")
                          {
                              $("#frame_actividad").attr("src","<%= request.protocol + request.host_with_port %>/compuertus/" + selectedObj.attr("idreal") +  "/edit?locale=<%= params[:locale]%>");
                          }
                          else if(selectedObj.attr("rel") == "loop")
                          {
                              $("#frame_actividad").attr("src","<%= request.protocol + request.host_with_port %>/loops/" + selectedObj.attr("idreal") +  "/edit?locale=<%= params[:locale]%>");
                          }
                          //OJO
                          else if(selectedObj.attr("rel") == "merge")
                          {
                              $("#frame_actividad").attr("src","<%= request.protocol + request.host_with_port %>/merges/" + selectedObj.attr("idreal") +  "/edit?locale=<%= params[:locale]%>");
                          }
//
                          else
                          {
                              $("#frame_actividad").attr("src","<%= request.protocol + request.host_with_port %>/blank.html");
                          }
                      })
                      .bind("remove.jstree", function (e, data) {
                          var tipo = data.rslt.obj.attr("rel");
                          var nombre = data.rslt.new_name;
                          var id_arbol = data.rslt.obj.attr("id");
                          var id_comp = data.rslt.obj.attr("idreal");
                          var controller = '';
                          var action = 'remove';

                          //nodos hijos para eliminacion de compuertas y nodos padre
                          var allChildren = $(data.rslt.obj).find("li");
                          var compuertas_hijas= new Array();
                          var actividades_hijas= new Array();
                          var rutas_hijas= new Array();
                          var hija = '';
                          for(var i=0;i<allChildren.length;i++){
                              hija = $(allChildren[i]).attr("rel");
                              if( hija == 'tarea_simple' || hija == 'tarea_multi_seq' || hija == 'tarea_multi_para' ){
                                  actividades_hijas[actividades_hijas.length] = $(allChildren[i]).attr("idreal");
                              }
                              if( hija == 'compuerta_inclu' || hija == 'compuerta_exclu' || hija == 'compuerta_para' ){
                                  compuertas_hijas[compuertas_hijas.length] = $(allChildren[i]).attr("idreal");
                              }
                              if( hija == 'ruta'  ){
                                  rutas_hijas[rutas_hijas.length] = $(allChildren[i]).attr("idreal");
                              }

                          }

                          var eliminar = true;

                          switch(tipo)
                          {
                              case 'tarea_simple':
                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_seq':

                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_para':

                                  controller = 'actividads';
                                  break;
                              case 'compuerta_inclu':

                                  if( actividades_hijas.length == 0){
                                      controller = 'compuertus';
                                  }else{
                                      alert("Esta compuerta tiene " + actividades_hijas.length + " actividades asociadas\n" +
                                      "por lo tanto no es posible eliminarla");
                                      eliminar = false;
                                  }
                                  break;
                              case 'compuerta_exclu':

                                  if( actividades_hijas.length == 0){
                                      controller = 'compuertus';
                                  }else{
                                      alert("Esta compuerta tiene " + actividades_hijas.length + " actividades asociadas\n" +
                                      "por lo tanto no es posible eliminarla");
                                      eliminar = false;
                                  }
                                  break;
                              case 'compuerta_para':

                                  if( actividades_hijas.length == 0){
                                      controller = 'compuertus';
                                  }else{
                                      alert("Esta compuerta tiene " + actividades_hijas.length + " actividades asociadas\n" +
                                      "por lo tanto no es posible eliminarla");
                                      eliminar = false;
                                  }
                                  break;
                              case 'evento_inicio':

                                  controller = 'eventos';
                                  break;
                              case 'evento_fin':

                                  controller = 'eventos';
                                  break;
                              case 'evento_intermedio':

                                  controller = 'eventos';
                                  break;
                              case 'ruta':
                                  if( actividades_hijas.length == 0){
                                      controller = 'ruta';
                                  }else{
                                      alert("Esta ruta tiene " + actividades_hijas.length + " actividades asociadas\n" +
                                      "por lo tanto no es posible eliminarla");
                                      eliminar = false;
                                  }
                                  break;
                              case 'loop':
                                  controller = 'loops';
                                  break;
                              //OJO
                              case 'merge':
                                  controller = 'merges';
                                  break;

                          }
                          var formdata = null;

                          formdata =
                          {
                              "nombre" : nombre,
                              "nodo_id" : id_arbol,
                              "actividades_hijas" : actividades_hijas,
                              "compuertas_hijas" : compuertas_hijas,
                              "rutas_hijas" : rutas_hijas
                          }
                          if (eliminar == true) {
                              var url = '<%= request.protocol + request.host_with_port %>/' + controller + '/' + id_comp + '/destroy';
                              $.ajax({
                                  url: url,
                                  data: formdata,
                                  cache: false,
                                  contentType: 'multipart/form-data',
                                  processData: true,
                                  type: 'POST',
                                  beforeSend: function (xhr) {
                                      xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))
                                  },
                                  success: function (data) {

                                      if (data == "true") {
                                      }// alert("Nodo creado con Ã©xito");
                                      else alert("No se pudo eliminar el nodo");
                                  }
                              });
                          }else{
                              $("#demo").jstree("refresh",-1);
                          }
                      })
                      .bind("move_node.jstree", function (e, data) {
                          data.rslt.o.each(function (i) {

                              //Lo puse encima de:
                              var tipo = data.rslt.r.attr("rel");
                              var id = data.rslt.r.attr("id");
                              var idParent = data.rslt.r.attr("idparent");
                              var position =  data.rslt.r.attr("pos");

                              //Datos del nodo movido
                              var tipo1 = data.rslt.o.attr("rel");
                              var id1 = data.rslt.o.attr("id");
                              var idParent1 = data.rslt.o.attr("idparent");
                              var position1 =  data.rslt.o.attr("pos");

                              var parent=  data.rslt.cr.attr("id");
                              var next=  data.rslt.or.attr("id");
                              //var prev=  data.rslt.o.previousSibling.attr("id");

                              var controller = 'my_js_trees';


                              var formdata = null;

                              formdata =
                              {
                                  "parentID" : parent,
                                  "nodo_id" : id1,
                                  "nextID": next
                              }

                              var url = '<%= request.protocol + request.host_with_port %>/' + controller+'/'+id+'/updateParent' ;
                              $.ajax({
                                  url: url,
                                  data: formdata,
                                  cache: false,
                                  contentType: 'multipart/form-data',
                                  processData: true,
                                  beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
                                  type: 'POST',
                                  success: function(data){

                                      if(data == "true"){} //alert("Nodo creado con Ã©xito");
                                      else alert("No se pudo actualizar el nodo");
                                  }

                              });
                          })
                      })
                      .bind("rename.jstree", function (e, data) {
                          var tipo = data.rslt.obj.attr("rel");
                          var nombre = data.rslt.new_name;
                          var id_arbol = data.rslt.obj.attr("id");
                          var id_comp = data.rslt.obj.attr("idreal");
                          var controller = '';
                          var action = 'update';



                          switch(tipo)
                          {
                              case 'tarea_simple':
                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_seq':

                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_para':

                                  controller = 'actividads';
                                  break;
                              case 'compuerta_inclu':

                                  controller = 'compuertus';
                                  break;
                              case 'compuerta_exclu':

                                  controller = 'compuertus';
                                  break;
                              case 'compuerta_para':

                                  controller = 'compuertus';
                                  break;
                              case 'evento_inicio':

                                  controller = 'eventos';
                                  break;
                              case 'evento_fin':

                                  controller = 'eventos';
                                  break;
                              case 'evento_intermedio':

                                  controller = 'eventos';
                                  break;
                              case 'ruta':
                                  controller = 'ruta';
                                  break;
                              case 'loop':
                                  controller = 'loops';
                                  break;

                          }
                          var formdata = null;

                          switch(controller)
                          {
                              case 'actividads':
                                  formdata =
                                  {
                                      //    "actividad[id]" : id_comp,
                                      "nombre" : nombre,
                                      "nodo_id" : id_arbol
                                  }

                                  break;
                              case 'compuertus':
                                  formdata =
                                  {
                                      "nombre" : nombre,
                                      "nodo_id" : id_arbol
                                  }
                                  break;
                              case 'eventos':
                                  formdata =
                                  {
                                      "nombre" : nombre,
                                      "nodo_id" : id_arbol
                                  }
                                  break;
                              case 'ruta':
                                  formdata =
                                  {
                                      "nombre" : nombre,
                                      "nodo_id" : id_arbol
                                  }
                                  break;
                              case 'loops':
                                  formdata =
                                  {
                                      "nombre" : nombre,
                                      "nodo_id" : id_arbol

                                  }
                                  break;
                          }


                          var url = '<%= request.protocol + request.host_with_port %>/' + controller+'/'+id_comp+'/updateName' ;
                          $.ajax({
                              url: url,
                              data: formdata,
                              cache: false,
                              contentType: 'multipart/form-data',
                              processData: true,


                              beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
                              type: 'POST',
                              success: function(data){

                                  if(data == "true"){}// alert("Nodo creado con Ã©xito");
                                  else alert("No se pudo actualizar el nodo");
                              }
                          });


                      })
                      .bind("create.jstree", function (e, data) {

                          var parent_id=data.rslt.parent.attr('idparent');

                          //if creating a root node
                          var id = data.rslt.parent.attr('id');

                          var action = 'create';
                          var tipo = data.rslt.obj.attr("rel");
                          var nombre = data.rslt.name;
                          var modo_ejecucion = 0;
                          var tipo_compuerta =  0;
                          var tipo_evento =  0;
                          var tipo_ruta =  0;
                          var controller = '';
                          var posicion = data.rslt.position;
                          <%if @proceso.nil?%>
                          var plantilla_id=<%= @plantilla.id %>;
                          <%else%>
                          var proceso_id=<%= @proceso.id %>;
                          <%end%>
                          var actividad_id = data.rslt.obj.attr("id")

                          switch(tipo)
                          {
                              case 'tarea_simple':
                                  modo_ejecucion = "1";
                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_seq':
                                  modo_ejecucion = "2";
                                  controller = 'actividads';
                                  break;
                              case 'tarea_multi_para':
                                  modo_ejecucion = "3";
                                  controller = 'actividads';
                                  break;
                              case 'compuerta_inclu': //checks
                                  tipo_compuerta = "1";
                                  controller = 'compuertus';
                                  break;
                              case 'compuerta_exclu':
                                  tipo_compuerta = "2";
                                  controller = 'compuertus';
                                  break;
                              case 'compuerta_para':
                                  tipo_compuerta = "3";
                                  controller = 'compuertus';
                                  break;
                              case 'evento_inicio':
                                  tipo_evento = "1";
                                  controller = 'eventos';
                                  break;
                              case 'evento_fin':
                                  tipo_evento = "2";
                                  controller = 'eventos';
                                  break;
                              case 'evento_intermedio':
                                  tipo_evento = "3";
                                  controller = 'eventos';
                                  break;
                              case 'ruta':
                                  tipo_evento = "1";
                                  controller = 'ruta';
                                  break;
                              case 'loop':
                                  controller = 'loops';
                                  break;
                              case 'merge':
                                  controller = 'merges';
                                  break;
                          }

                          var formdata = null;
                          switch(controller)
                          {
                              case 'actividads':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "actividad[plantilla_id]" : plantilla_id,
                                      <%else%>
                                      "actividad[proceso_id]" : proceso_id,
                                      <%end%>
                                      "actividad[nombre]" : nombre,
                                      "actividad[descripcion]" : "",
                                      "actividad[duracion]" : "1",
                                      "actividad[modoejecucion]" : modo_ejecucion,
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion,
                                      "actividad_id": actividad_id
                                  }
                                  break;
                              case 'compuertus':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "compuertu[plantilla_id]" :  plantilla_id,
                                      <%else%>
                                      "compuertu[proceso_id]" :  proceso_id,
                                      <%end%>
                                      "compuertu[nombre]" : nombre,
                                      "compuertu[descripcion]" : "",
                                      "compuertu[tipo]" : tipo_compuerta,
                                      "compuertu[desicion]" :"1",
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion
                                  }
                                  break;
                              case 'eventos':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "evento[plantilla_id]" : plantilla_id,
                                      <%else%>
                                      "evento[proceso_id]" : proceso_id,
                                      <%end%>
                                      "evento[nombre]" : nombre,
                                      "evento[descripcion]" : "",
                                      "evento[tipo]" : tipo_evento,
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion
                                  }
                                  break;
                              case 'ruta':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "rutum[plantilla_id]" :  plantilla_id,
                                      <%else%>
                                      "rutum[proceso_id]" :  proceso_id,
                                      <%end%>
                                      "rutum[nombre]" : nombre,
                                      "rutum[descripcion]" : "",
                                      "rutum[tipo]" : tipo_evento,
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion
                                  }
                                  break;
                              case 'loops':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "loop[plantilla_id]" :  plantilla_id,
                                      <%else%>
                                      "loop[proceso_id]" :  proceso_id,
                                      <%end%>
                                      "loop[nombre]" : nombre,
                                      "loop[compuerta_id]" : "",
                                      "loop[actividad_id]" : "",
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion
                                  }
                                  //alert("aca");
                                  break;
                              case 'merges':
                                  formdata =
                                  {
                                      <%if @proceso.nil?%>
                                      "merge[plantilla_id]" :  plantilla_id,
                                      <%else%>
                                      "merge[proceso_id]" :  proceso_id,
                                      <%end%>
                                      "merge[nombre]" : nombre,
                                      "nodo_padre" : id,
                                      "nodo_titulo" : nombre,
                                      "nodo_tipo" : tipo,
                                      "posicion": posicion
                                  }

                                  break;
                          }

                          var url = '<%= request.protocol + request.host_with_port %>/' + controller;
                          $.ajax({
                              url: url,
                              data: formdata,
                              cache: false,
                              contentType: 'multipart/form-data',
                              beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
                              processData: true,
                              type: 'POST',
                              error: function (xhr, status) {
                                  var e = document.getElementById("NuevoNodo");
                                  e.id = data;
                                  //   alert(status);
                              },
                              success: function(data){

                                  if(data == "false"){
                                      alert("No se pudo crear el nodo");

                                  }// alert("Nodo creado con Ã©xito");
                                  else {
                                      //$("#NuevoNodo").setAttribute("id","<%= MyJsTree.last().id %>")
                                      // data.inst.refresh();
                                      var e = document.getElementById("NuevoNodo");
                                      e.id = data;//"<%= MyJsTree.last().id %>";
                                      //
                                      // data.inst.refresh();
                                  }
                              }
                          });
                          $("#demo").jstree("refresh");
                      })
          });
          <%if !@plantilla.nil? || @proceso.estado != "publicado" %>
          $.cambiar_elemento = function(obj, nuevo_tipo_nodo, nuevo_tipo) {
            var tipo = obj.attr("rel");
            var nuevo_tipo = nuevo_tipo;
            var nuevo_tipo_nodo = nuevo_tipo_nodo;
            var id_arbol = obj.attr("id");
            var id_comp = obj.attr("idreal");
            var controller = '';
            var action = 'update';
            switch(tipo)
            {
                case 'tarea_simple':
                    controller = 'actividads';
                    break;
                case 'tarea_multi_seq':

                    controller = 'actividads';
                    break;
                case 'tarea_multi_para':

                    controller = 'actividads';
                    break;
                case 'compuerta_inclu':

                    controller = 'compuertus';
                    break;
                case 'compuerta_exclu':

                    controller = 'compuertus';
                    break;
                case 'compuerta_para':

                    controller = 'compuertus';
                    break;
            }

            var formdata = null;
            formdata =
            {
                "nuevo_tipo_nodo" : nuevo_tipo_nodo,
                "nuevo_tipo": nuevo_tipo,
                "nodo_id" : id_arbol

            }
            var url = '<%= request.protocol + request.host_with_port %>/' + controller+'/'+id_comp+'/updateType' ;
            $.ajax({
                url: url,
                data: formdata,
                cache: false,
                contentType: 'multipart/form-data',
                processData: true,
                beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
                type: 'POST',
                success: function(data){

                    if(data == "true"){}// alert("Nodo creado con Ã©xito");
                    else alert("No se pudo actualizar el nodo");
                }
                });
            $("#demo").jstree("refresh");
            }
          <%end%>
      </script>
    </div>
  </div>
</div>
